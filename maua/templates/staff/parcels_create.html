{% extends 'staff/_layout.html' %}

{% block title %}Create Parcel{% endblock %}
{% block page_title %}Register New Parcel{% endblock %}
{% block page_subtitle %}Create a parcel delivery for a customer at the depot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-box me-2"></i>Parcel Details</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('staff.parcels_create') }}" enctype="multipart/form-data">
                    <!-- Sender Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-user me-2 text-primary"></i>Sender Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sender_name" class="form-label fw-semibold">
                                        Sender Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="sender_name" name="sender_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="sender_phone" class="form-label fw-semibold">
                                        Sender Phone <span class="text-danger">*</span>
                                    </label>
                                    <input type="tel" class="form-control" id="sender_phone" name="sender_phone" 
                                           required placeholder="e.g. 0712345678">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="sender_email" class="form-label fw-semibold">
                                        Sender Email <span class="text-muted small">(for notifications)</span>
                                    </label>
                                    <input type="email" class="form-control" id="sender_email" name="sender_email" 
                                           placeholder="e.g. sender@example.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="sender_id_number" class="form-label fw-semibold">Sender ID Number</label>
                                    <input type="text" class="form-control" id="sender_id_number" name="sender_id_number" 
                                           placeholder="National ID">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Receiver Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-user-check me-2 text-success"></i>Receiver Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="receiver_name" class="form-label fw-semibold">
                                        Receiver Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="receiver_name" name="receiver_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="receiver_phone" class="form-label fw-semibold">
                                        Receiver Phone <span class="text-danger">*</span>
                                    </label>
                                    <input type="tel" class="form-control" id="receiver_phone" name="receiver_phone" 
                                           required placeholder="e.g. 0712345678">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="receiver_email" class="form-label fw-semibold">
                                        Receiver Email <span class="text-muted small">(for notifications)</span>
                                    </label>
                                    <input type="email" class="form-control" id="receiver_email" name="receiver_email" 
                                           placeholder="e.g. receiver@example.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="receiver_id_number" class="form-label fw-semibold">Receiver ID Number</label>
                                    <input type="text" class="form-control" id="receiver_id_number" name="receiver_id_number" 
                                           placeholder="National ID">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Parcel Details -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-box-open me-2 text-warning"></i>Parcel Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="origin_name" class="form-label fw-semibold">
                                        Origin (From) <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="origin_name" name="origin_name" 
                                           required placeholder="e.g. Nairobi">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="destination_name" class="form-label fw-semibold">
                                        Destination (To) <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="destination_name" name="destination_name" 
                                           required placeholder="e.g. Meru">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="weight_kg" class="form-label fw-semibold">Weight (kg)</label>
                                    <input type="number" class="form-control" id="weight_kg" name="weight_kg" 
                                           step="0.1" min="0" placeholder="0.0">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="price" class="form-label fw-semibold">
                                        Price (KES) <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="price" name="price" 
                                           required min="0" step="1" placeholder="e.g. 500">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="parcel_photo" class="form-label fw-semibold">Parcel Photo</label>
                                    <input type="file" class="form-control" id="parcel_photo" name="parcel_photo" 
                                           accept="image/*" onchange="previewImage(this)">
                                    <!-- Image Preview Container -->
                                    <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                                        <div class="position-relative d-inline-block">
                                            <img id="imagePreview" src="#" alt="Parcel preview" 
                                                 class="img-thumbnail rounded shadow-sm" 
                                                 style="max-width: 200px; max-height: 200px; object-fit: cover;">
                                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                    onclick="clearImagePreview()" title="Remove photo">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <p class="text-muted small mt-1 mb-0" id="imageFileName"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2 text-success"></i>Payment Method</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check card p-3 border mb-2">
                                        <input class="form-check-input" type="radio" name="payment_method" 
                                               id="payment_cash" value="cash" checked>
                                        <label class="form-check-label ms-2" for="payment_cash">
                                            <strong><i class="fas fa-money-bill-alt me-2 text-success"></i>Cash Payment</strong>
                                            <p class="mb-0 small text-muted">Customer pays cash at counter</p>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check card p-3 border mb-2">
                                        <input class="form-check-input" type="radio" name="payment_method" 
                                               id="payment_mpesa" value="mpesa">
                                        <label class="form-check-label ms-2" for="payment_mpesa">
                                            <strong><i class="fas fa-mobile-alt me-2 text-success"></i>M-Pesa</strong>
                                            <p class="mb-0 small text-muted">Customer will pay via M-Pesa STK push</p>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="{{ url_for('staff.parcels_list') }}" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-check me-2"></i>Register Parcel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2 text-info"></i>Process</h6>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">Fill in sender details</li>
                    <li class="mb-2">Fill in receiver details</li>
                    <li class="mb-2">Enter origin and destination</li>
                    <li class="mb-2">Set weight and price</li>
                    <li class="mb-2">Select payment method</li>
                    <li class="mb-2">Click "Register Parcel"</li>
                    <li>Print receipt for customer</li>
                </ol>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Important</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2">
                        <i class="fas fa-phone text-primary me-2"></i>
                        Verify phone numbers before submitting
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-sms text-success me-2"></i>
                        SMS will be sent to sender and receiver
                    </li>
                    <li>
                        <i class="fas fa-receipt text-info me-2"></i>
                        Always give customer their receipt
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function previewImage(input) {
    const previewContainer = document.getElementById('imagePreviewContainer');
    const preview = document.getElementById('imagePreview');
    const fileName = document.getElementById('imageFileName');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            input.value = '';
            clearImagePreview();
            return;
        }
        
        // Validate file size (max 5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            alert('Image size must be less than 5MB.');
            input.value = '';
            clearImagePreview();
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.src = e.target.result;
            previewContainer.style.display = 'block';
            fileName.textContent = file.name + ' (' + formatFileSize(file.size) + ')';
            
            // Add a nice fade-in animation
            preview.style.opacity = '0';
            setTimeout(function() {
                preview.style.transition = 'opacity 0.3s ease-in-out';
                preview.style.opacity = '1';
            }, 50);
        };
        
        reader.readAsDataURL(file);
    } else {
        clearImagePreview();
    }
}

function clearImagePreview() {
    const previewContainer = document.getElementById('imagePreviewContainer');
    const preview = document.getElementById('imagePreview');
    const fileInput = document.getElementById('parcel_photo');
    const fileName = document.getElementById('imageFileName');
    
    preview.src = '#';
    previewContainer.style.display = 'none';
    fileName.textContent = '';
    fileInput.value = '';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}
</script>
{% endblock %}

{% extends 'staff/_layout.html' %}

{% block title %}Seat Map{% endblock %}
{% block page_title %}Trip Seat Map{% endblock %}
{% block page_subtitle %}{{ trip.route.origin.town }} → {{ trip.route.destination.town }} | {{ trip.vehicle.plate_no }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Mark as Full Toggle Card -->
        <div class="card mb-3 {% if trip.is_full %}border-warning{% endif %}">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-users me-2 {% if trip.is_full %}text-warning{% else %}text-muted{% endif %}"></i>
                        <span class="{% if trip.is_full %}fw-bold text-warning{% else %}text-muted{% endif %}">
                            {% if trip.is_full %}
                                <i class="fas fa-check-circle me-1"></i>Trip Marked as Full
                            {% else %}
                                Physical Check-ins (Walk-ins)
                            {% endif %}
                        </span>
                    </div>
                    <form method="post" action="{{ url_for('staff.trip_mark_full', trip_id=trip.id) }}" class="d-inline">
                        <button type="submit" class="btn {% if trip.is_full %}btn-outline-secondary{% else %}btn-warning{% endif %} btn-sm"
                                onclick="return confirm('{% if trip.is_full %}Unmark this trip as full?{% else %}Mark this trip as full? All remaining empty seats will be automatically marked as checked-in walk-in passengers.{% endif %}')">
                            {% if trip.is_full %}
                                <i class="fas fa-unlock me-1"></i>Unmark Full
                            {% else %}
                                <i class="fas fa-car-side me-1"></i>Mark as Full
                            {% endif %}
                        </button>
                    </form>
                </div>
                {% if trip.is_full %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle me-1"></i>This trip is no longer available for online bookings.
                </small>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-th me-2 text-primary"></i>Seat Layout</h5>
                    <div>
                        <span class="badge bg-success me-1">Checked In</span>
                        <span class="badge bg-primary me-1">Booked</span>
                        <span class="badge bg-danger">Available</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 justify-content-center" id="seat-grid" data-trip-id="{{ trip.id }}">
                    {% for s in seat_layout %}
                        {% set code = s['seat'] %}
                        {% set b = seat_to_booking.get(code) %}
                        {% set color = 'danger' %}
                        {% if b %}
                            {% if b.status in ['checked_in', 'completed'] %}
                                {% set color = 'success' %}
                            {% else %}
                                {% set color = 'primary' %}
                            {% endif %}
                        {% endif %}
                        <div class="seat-box bg-{{ color }} text-white rounded p-2 text-center seat-badge" 
                             data-seat="{{ code }}" style="min-width: 70px; cursor: pointer;">
                            <div class="fw-bold">{{ code }}</div>
                            {% if b %}
                                <small class="d-block" style="font-size: 0.65rem;">{{ b.passenger_name[:10] }}{% if b.passenger_name|length > 10 %}...{% endif %}</small>
                                {% if b.status not in ['checked_in', 'completed'] %}
                                <form method="post" action="{{ url_for('staff.trip_seat_checkin', trip_id=trip.id, seat=code) }}" class="mt-1">
                                    <button class="btn btn-xs btn-light" type="submit" style="font-size: 0.65rem; padding: 2px 6px;">
                                        Check In
                                    </button>
                                </form>
                                {% endif %}
                            {% else %}
                                <small class="d-block" style="font-size: 0.65rem;">Available</small>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <a class="btn btn-outline-secondary" href="{{ url_for('staff.trips_list') }}">
                <i class="fas fa-arrow-left me-2"></i>Back to Trips
            </a>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2 text-info"></i>Trip Details</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-muted small">ROUTE</label>
                    <div class="fw-bold">
                        {{ trip.route.origin.town }} → {{ trip.route.destination.town }}
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted small">VEHICLE</label>
                    <div class="fw-bold">{{ trip.vehicle.plate_no }}</div>
                    <small class="text-muted">{{ trip.vehicle.make }} {{ trip.vehicle.model }}</small>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted small">DEPARTURE</label>
                    <div class="fw-bold">{{ trip.depart_at.strftime('%b %d, %Y at %H:%M') }}</div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted small">DRIVER</label>
                    <div>{{ trip.driver_name or '—' }}</div>
                    <small class="text-muted">{{ trip.driver_phone or '' }}</small>
                </div>
                <div>
                    <label class="form-label text-muted small">STATUS</label>
                    <div>
                        {% set status_class = {
                            'scheduled': 'bg-info',
                            'in_progress': 'bg-warning text-dark',
                            'completed': 'bg-success',
                            'cancelled': 'bg-danger'
                        } %}
                        <span class="badge {{ status_class.get(trip.status, 'bg-secondary') }} fs-6">
                            {{ trip.status|replace('_', ' ')|title }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seat Info Modal -->
<div class="modal fade" id="seatInfoModal" tabindex="-1" aria-labelledby="seatInfoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title mb-0" id="seatInfoLabel">Seat Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="seatInfoBody">
                    <div class="text-center py-4 text-muted">Loading…</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const grid = document.getElementById('seat-grid');
    const tripId = grid.getAttribute('data-trip-id');
    const modalEl = document.getElementById('seatInfoModal');
    const modal = new bootstrap.Modal(modalEl);
    const body = document.getElementById('seatInfoBody');
    const titleEl = document.getElementById('seatInfoLabel');

    grid.addEventListener('click', async function (e) {
        const target = e.target.closest('.seat-badge');
        if (!target) return;
        if (e.target.tagName === 'BUTTON') return; // Don't trigger for check-in button
        
        const seat = target.getAttribute('data-seat');
        titleEl.textContent = `Seat Details — ${seat}`;
        body.innerHTML = '<div class="text-center py-4 text-muted">Loading…</div>';
        modal.show();
        
        try {
            const res = await fetch(`/staff/trips/${tripId}/seats/${seat}/booking.json`, { headers: { 'Accept': 'application/json' } });
            if (!res.ok) {
                body.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5>Seat ${seat} is Available</h5>
                        <p class="text-muted">No booking found for this seat.</p>
                    </div>`;
                return;
            }
            const data = await res.json();
            if (!data.found) {
                body.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5>Seat ${seat} is Available</h5>
                        <p class="text-muted">No booking found for this seat.</p>
                    </div>`;
                return;
            }
            const b = data.booking;
            const statusBadgeClass = (s => {
                if (['checked_in','completed'].includes(s)) return 'bg-success';
                if (['confirmed','reserved'].includes(s)) return 'bg-primary';
                if (['cancelled'].includes(s)) return 'bg-danger';
                return 'bg-secondary';
            })(b.status || '');

            body.innerHTML = `
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="text-muted small">SEAT</label>
                        <div class="h4 fw-bold">${b.seat_number}</div>
                    </div>
                    <div class="col-6 text-end">
                        <span class="badge ${statusBadgeClass} fs-6">${(b.status || '').replace('_',' ').toUpperCase()}</span>
                    </div>
                </div>
                <hr>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="text-muted small">PASSENGER</label>
                        <div class="fw-bold">${b.passenger_name}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">PHONE</label>
                        <div>${b.passenger_phone}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">GENDER / AGE</label>
                        <div>${b.passenger_sex}, ${b.passenger_age} years</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">NATIONAL ID</label>
                        <div>${b.passenger_id_number}</div>
                    </div>
                    <div class="col-12">
                        <label class="text-muted small">PICKUP LOCATION</label>
                        <div>${b.pickup_location || '—'}</div>
                    </div>
                    <div class="col-12">
                        <label class="text-muted small">REFERENCE</label>
                        <div class="fw-bold text-primary">${b.reference}</div>
                    </div>
                </div>`;
        } catch (err) {
            body.innerHTML = `<div class="alert alert-danger">Error loading seat details.</div>`;
        }
    });
});
</script>
{% endblock %}
